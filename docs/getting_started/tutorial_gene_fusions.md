# 2. Step: Detection of Gene Fusion Events
In this part of the turorial we will focus on the detection of gene fusion events.
This is achieved by the second module of SnakeSplice, which is called `module2_gene_fusion_detection`.

!!! warning "Required input"  
    To be able to execute the second module, you need to have successfully executed the first module.
    Or you need to provide the necessary input BAM files and specify their location in the configuration file.

    **Required input files**: BAM files (aligned reads) from the first module.


We decide to use the following tool for this module:

- **Arriba**: Arriba is a tool for gene fusion detection in RNA-Seq data.

## 2.1 Main configuration file
In order to run the second module, you need to adjust the main configuration file `config_files/config_main.yaml`.
Keep the settings of the first module as they are but also switch on the second module.
An excerpt of an example configuration file is shown below:

``` yaml title="config_main.yaml" hl_lines="11 14"
[...]
global_variable:
  run_identifier: "tutorial_run"

[...]
module_switches:
  # ------- 1.0 Module: Report Generation ---------
  run_module0_report_generation: False

  # ------- 1.1 Module: Quality-Control, Preprocessing, and Alignment --------
  run_module1_qc_preprocessing_and_alignment: True

  # ------- 1.2 Module: Detection of gene fusion events ---------
  run_module2_gene_fusion_detection: True
  
  # ------- 1.3 Module: Detection and Quantification of gene products (transcripts) and analysis ---------
  run_module3_gene_expression_quantification_and_analysis: False

  # ------- 1.4 Module: Splicing Patterns Analysis ---------
  run_module4_splicing_pattern_analysis: False
[...]
```

The complete configuration file for this example can be downloaded here: [config_main.yaml](example_data/mod2/config_main.yaml).
Make sure to have this file saved under `config_files/config_main.yaml` in your project directory.

## 2.2 Module configuration file
Let's specify arriba's parameters by adjusting the module configuration file `config_files/config_module2_gene_fusion.yaml`.
Make sure to switch on the Arriba tool and specify the location of the input BAM files.

!!! tip "Input BAM files"
    If you have executed the first module, you can simply put `star` as `input_dir_of_bam_files` and SnakeSplice will automatically find the BAM files generated by **STAR**.


!!! note "Reference genome build"
    **Remember**: We only need to reference the 21. chromosome (GRCh38_chr21).

Other options can be left as they are.

!!! tip "Arriba Black list"
    Though if you would like to you can download [arriba's optional black list](https://arriba.readthedocs.io/en/latest/input-files/#blacklist) and reference it in the configuration file.
    That list is not necessary for the pipeline to run, but is highly recommended to use it.

An excerpt of the configuration file with the relevant settings is shown below:


``` yaml title="config_module2_gene_fusion.yaml" hl_lines="7 17 23"
[...]
# =============== 1. Module: Gene Fusion Detection - Primary settings =============
module2_gene_fusion_detection_settings:

 # ------- 1.1 Tool Switches --------
  switch_variables:
    run_fusion_detection_with_arriba: True        # Detect gene fusion events with Arriba

  # =============== 1.2 Output directories =============
  # The output directories for the respective tool-outputs are defined here.
  # This is important for importing the outputs into the GUI
  output_directories:
    arriba_output_dir: "arriba"
[...]

  input_dir_of_bam_files:
    "star"

  # Attributes of aligned files (input BAM files)
  bam_files_attributes:
    # Reference genome build that was used to create the input BAM files
    reference_genome_build:
      "GRCh38_chr21"          # "GRCh37" or "GRCh38" or "GRCh38_chr21" (for testing purposes)
[...]
```

To follow this tutorial you can use the `config_module2_gene_fusion.yaml` file as is provided through the SnakeSplice repository. However, the example configuration file can also be downloaded here: [config_module2_gene_fusion.yaml](example_data/mod2/config_module2_gene_fusion.yaml).


## 2.3 Execution
We have set up the main and module configuration files for the second module.
Now we can execute the SnakeSplice pipeline again, which will let us generate an analysis 
of potential gene fusion events.

But let's first make a quick check if everything is set up correctly.
To do so, navigate to the main directory (`snakesplice`) of SnakeSplice and execute a dry run:
``` bash title="Dry run"
snakemake --profile profiles/profile_local/ -n
```

You should see a list of all rules that would be executed if you would run the pipeline.
After the dry run, you can execute the pipeline by running the following command:

``` bash title="Execution"
snakemake --profile profiles/profile_local/

# Alternative: Run pipeline in background & write logs to a specified file
nohup snakemake --profile profiles/profile_local &> output-$(date +"%Y-%m-%dT%H-%M-%S").txt &
```

## 2.4 Results & HTML report
By default the results of the second module are stored in the `output/module2_gene_fusion_detection/output/` directory .
Feel free to explore the results directly in your file system.



## 2.5 Troubleshooting
Here are some issues that might occur during the execution of first module of the pipeline:

<span style="color:red;">TODO</span>



## 2.6 Celebrate
**Congratulations!**
You have successfully executed the second module of SnakeSplice and identified potential gene fusion events.

You can now proceed with the third module: [Detection and Quantification of gene products (transcripts) and analysis](tutorial_gene_expression.md).
